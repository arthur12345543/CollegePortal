Spud=typeof Spud=="undefined"?{}:Spud,Spud.Admin=typeof Spud.Admin=="undefined"?{}:Spud.Admin,Spud.Admin.Photos=new function(){var e=this,t=!1;this.init=function(){$(".spud_admin_photo_ui_thumbs_sortable").sortable({connectWith:".spud_admin_photo_ui_thumbs_sortable"}),$("body").on("submit","#spud_admin_photo_album_form",e.submittedPhotoAlbumForm),$("body").on("submit","#spud_admin_photo_gallery_form",e.submittedPhotoGalleryForm),$("body").on("submit","#spud_admin_photo_form",e.submittedPhotoForm),$("body").on("click",".spud_admin_photos_btn_remove",e.clickedPhotoRemoveFromAlbum),$("body").on("click",".spud_admin_photo_ui_thumbs_selectable .spud_admin_photo_ui_thumb",e.selectedPhotoUiThumb),$("body").on("click","#spud_admin_photo_album_action_library",e.clickedPhotoLibrary),$("body").on("click","#spud_admin_photo_album_action_upload, .spud_admin_photo .spud_admin_photos_btn_edit",e.clickedPhotoAddOrEdit),$("body").on("click",".spud_admin_photo_library_add_selected",e.addSelectedPhotosFromLibrary),$("body").on("click",".spud_admin_photo_library_delete_selected",e.deleteSelectedPhotosFromLibrary);if(typeof FormData!="undefined"&&typeof XMLHttpRequest!="undefined"&&(droparea=document.getElementById("spud_admin_photo_upload_queue"))){t=!0,$("#spud_admin_photo_upload_queue").show(),droparea.addEventListener("dragenter",e.stopDndPropagation,!1),droparea.addEventListener("dragexit",e.stopDndPropagation,!1),droparea.addEventListener("dragover",e.stopDndPropagation,!1),droparea.addEventListener("drop",e.droppedFile,!1);var n=document.getElementsByTagName("body")[0];n.addEventListener("dragenter",e.stopDndPropagation,!1),n.addEventListener("dragexit",e.stopDndPropagation,!1),n.addEventListener("dragover",e.stopDndPropagation,!1),n.addEventListener("drop",e.stopDndPropagation,!1)}},this.submittedPhotoAlbumForm=function(e){},this.submittedPhotoGalleryForm=function(e){$("#spud_admin_photo_albums_available .spud_admin_photo_ui_thumb").remove()},this.clickedPhotoRemoveFromAlbum=function(e){return $(this).parents(".spud_admin_photo_ui_thumb").fadeOut(200,function(){$(this).remove()}),!1},this.photoLegacyUploadErrors=function(e){$("#spud_admin_photo_form").replaceWith(e)},this.photoLegacyUploadComplete=function(e,t){var n=$("#spud_admin_photo_"+e);if(n.length>0)n.replaceWith(t);else{var r=$("#spud_admin_photos_selected, #spud_admin_photos");r.prepend(t)}hideModalDialog()},this.selectedPhotoUiThumb=function(e){var t=$(this);t.hasClass("spud_admin_photo_ui_thumb_selected")?$(this).removeClass("spud_admin_photo_ui_thumb_selected"):$(this).addClass("spud_admin_photo_ui_thumb_selected")},this.markPhotoAsDeleted=function(e){var t=$("#spud_admin_photo_"+e);t.fadeOut(200,function(){t.remove()})},this.markPhotoAlbumAsDeleted=function(e){var t=$("#spud_admin_photo_album_"+e);t.fadeOut(200,function(){t.remove()})},this.markPhotoGalleryAsDeleted=function(e){var t=$("#spud_admin_photo_gallery_"+e);t.fadeOut(200,function(){t.remove()})},this.submittedPhotoForm=function(n){if(t){var r=new FormData,i=$(this);r.append("_method",i.find("[name=_method]").val()),r.append("authenticity_token",i.find("[name=authenticity_token]").val()),r.append("spud_photo[title]",i.find("#spud_photo_title").val()),r.append("spud_photo[caption]",i.find("#spud_photo_caption").val());var s,o=i.find("#spud_photo_photo")[0].files[0];o?(s=e.progressBarForUpload(o.name),r.append("spud_photo[photo]",o),i.append(s)):s=e.progressBarForUpload("");var u=new XMLHttpRequest;return u.upload.addEventListener("progress",function(t){e.onPhotoUploadProgress(t,s)},!1),u.addEventListener("load",function(t){e.onPhotoUploadComplete(t,s)},!1),u.addEventListener("error",function(t){e.onPhotoUploadFailure(t,s)},!1),u.addEventListener("abort",function(t){e.onPhotoUploadCancel(t,s)},!1),u.open("POST",i.attr("action")),u.setRequestHeader("X-Requested-With","XMLHttpRequest"),u.send(r),!1}},this.progressBarForUpload=function(e){var t=['<div class="spud_admin_photo_progress">',"<h6>",'<span class="spud_admin_photo_progress_filename">'+e+"</span>: ",'<span class="spud_admin_photo_progress_status">Uploading</span>',"</h6>",'<div class="progress progress-striped active">','<div class="bar" style="width: 0;"></div>',"</div>","</div>"].join("");return $(t)},this.onPhotoUploadProgress=function(e,t){var n=Math.round(e.loaded*100/e.total);t.find(".bar").css({width:n+"%"}),n==100&&(t.find(".progress").addClass("progress-success"),t.find(".spud_admin_photo_progress_status").text("Processing"))},this.onPhotoUploadComplete=function(e,t){var n=$.parseJSON(e.target.response);if(e.target.status==200){t.find(".spud_admin_photo_progress_status").text("Done!"),t.find(".progress").removeClass("progress-striped active");var r=$("#spud_admin_photo_"+n.id);if(r.length>0)r.replaceWith(n.html);else{var i=$("#spud_admin_photos_selected, #spud_admin_photos");i.prepend(n.html).fadeIn(200)}hideModalDialog()}else $("#modal_window .modal-body").html(n.html)},this.onPhotoUploadCancel=function(e,t){t.find(".spud_admin_photo_progress_status").text("Done!"),t.find(".progress").addClass("progress-danger")},this.clickedPhotoAddOrEdit=function(t){var n=this.href;return $.ajax({url:n,success:e.photoUploadFormLoaded}),!1},this.photoUploadFormLoaded=function(e){displayModalDialogWithOptions({title:"Upload Photo",html:e})},this.clickedPhotoLibrary=function(t){var n=this.href;return $.ajax({url:n,success:e.photoLibraryLoaded}),!1},this.photoLibraryLoaded=function(e){var t=$("#modal_window");$("#spud_admin_photos_selected .spud_admin_photo_ui_thumb").each(function(){var e=$(this).attr("id"),n=t.find("#"+e);n&&n.remove()}),displayModalDialogWithOptions({title:"My Photo Library",html:e,buttons:{"spud_admin_photo_library_add_selected btn-primary":"Add Selected","spud_admin_photo_library_delete_selected btn-danger":"Delete Selected"}})},this.addSelectedPhotosFromLibrary=function(e){$("#spud_admin_photo_library .spud_admin_photo_ui_thumb_selected").removeClass("spud_admin_photo_ui_thumb_selected").prependTo("#spud_admin_photos_selected").hide().fadeIn(200),hideModalDialog()},this.deleteSelectedPhotosFromLibrary=function(e){var t=$.map($(".spud_admin_photo_ui_thumb_selected"),function(e,t){return $(e).attr("rel")});$.ajax({type:"POST",url:"/spud/admin/photos/mass_destroy",data:{spud_photo_ids:t},success:function(e,t,n){$(".spud_admin_photo_ui_thumb_selected").fadeOut(200,function(){$(this).remove()})},error:function(e,t,n){console.log("An error occurred:"),console.log(arguments)}})},this.fileQueue=[],this.fileQueueStarted=!1,this.stopDndPropagation=function(e){e.stopPropagation(),e.preventDefault()},this.droppedFile=function(t){t.stopPropagation(),t.preventDefault(),$("#spud_admin_photo_upload_queue").show();var n=t.dataTransfer.files,r=0;while(r<n.length)e.fileQueue.push(n[r]),r++;e.updateQueueCountLabel(),this.fileQueueStarted||(e.uploadNextPhoto(),e.fileQueue.length>0&&e.uploadNextPhoto())},this.updateQueueCountLabel=function(){$("#spud_admin_photo_upload_queue_label span").text(e.fileQueue.length)},this.uploadNextPhoto=function(){if(e.fileQueue.length===0){e.fileQueueStarted=!1;return}e.fileQueueStarted=!0;var t=e.fileQueue.pop(),n=new FormData;n.append("spud_photo[photo]",t);var r=e.progressBarForUpload(t.name);$("#spud_admin_photo_upload_queue_bars").prepend(r);var i=new XMLHttpRequest;i.upload.addEventListener("progress",function(t){e.onPhotoUploadProgress(t,r)},!1),i.addEventListener("load",function(t){e.onQueuedPhotoUploadComplete(t,r)},!1),i.addEventListener("error",function(t){e.onPhotoUploadFailure(t,r)},!1),i.addEventListener("abort",function(t){e.onPhotoUploadCancel(t,r)},!1),i.open("POST","/spud/admin/photos"),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send(n)},this.onQueuedPhotoUploadComplete=function(t,n){e.onPhotoUploadComplete(t,n),e.updateQueueCountLabel(),e.uploadNextPhoto()}};